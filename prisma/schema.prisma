// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum ClientStatus {
  NEW_LEAD
  IN_CONTACT
  DEMO_SENT
  NEGOTIATION
  ACTIVE_CLIENT
  LOST
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
}

enum ContactType {
  PHONE_CALL
  MEETING
  EMAIL
  LINKEDIN_MESSAGE
  OTHER
}

enum ClientPriority {
  LOW
  MEDIUM
  HIGH
}

enum ClientType {
  PERSON
  COMPANY
}

enum PlanType {
  BASIC
  PRO
}


model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  password      String? // Nullable for OAuth users
  role          UserRole  @default(USER)
  position      String?
  organizationId String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  organization    Organization? @relation(fields: [organizationId], references: [id])
  assignedClients Client[]         @relation("ClientAssignee")
  assignedTasks   Task[]           @relation("TaskAssignee")
  contacts        Contact[]
  groups          UserGroup[]
  activities      ActivityLog[]
  preferences     UserPreferences?

  @@index([organizationId])
  @@map("users")
}

model Group {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users          UserGroup[]
  sharedClients  Client[]    @relation("GroupSharedClients")
  sharedTasks    Task[]      @relation("GroupSharedTasks")
  sharedContacts Contact[]   @relation("GroupSharedContacts")

  @@map("groups")
}

model UserGroup {
  id        String   @id @default(cuid())
  userId    String
  groupId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@map("user_groups")
}

model Client {
  id             String          @id @default(cuid())
  type           ClientType      @default(PERSON)
  // Fields for PERSON type
  firstName      String?
  lastName       String?
  // Fields for COMPANY type
  // companyName    String? // Temporarily commented out - column doesn't exist in database yet
  taxId          String? // NIP / Tax ID
  // Common fields
  email          String?
  phone          String?
  website        String?
  address        String?
  source         String? // Lead source
  status         ClientStatus    @default(NEW_LEAD)
  priority       ClientPriority? // Priority for prospecting
  assignedTo     String? // User ID
  organizationId String?
  lastContactAt  DateTime? // Last contact date (auto-updated)
  nextFollowUpAt DateTime? // Next follow-up date
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Relations
  organization   Organization?   @relation(fields: [organizationId], references: [id])
  assignee      User?                 @relation("ClientAssignee", fields: [assignedTo], references: [id])
  contacts      Contact[]
  tasks         Task[]
  statusHistory ClientStatusHistory[]
  sharedGroups  Group[]               @relation("GroupSharedClients")
  integrationTabs IntegrationTab[]

  @@index([assignedTo])
  @@index([status])
  @@index([type])
  @@index([organizationId])
  @@index([lastContactAt])
  @@index([nextFollowUpAt])
  @@index([assignedTo, status])
  @@map("clients")
}

model ClientStatusHistory {
  id        String       @id @default(cuid())
  clientId  String
  status    ClientStatus
  changedAt DateTime     @default(now())
  changedBy String? // User ID
  notes     String?

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_status_history")
}

model Contact {
  id        String       @id @default(cuid())
  clientId  String
  type      ContactType? // Optional for notes (isNote=true)
  date      DateTime     @default(now())
  notes     String
  isNote    Boolean      @default(false) // Flag to distinguish notes from contacts
  userId    String // User who created the contact
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])
  attachments  Attachment[]
  sharedGroups Group[]      @relation("GroupSharedContacts")

  @@index([clientId])
  @@index([userId])
  @@index([date])
  @@map("contacts")
}

model Attachment {
  id        String   @id @default(cuid())
  contactId String
  filename  String
  path      String // File path or URL
  size      Int? // File size in bytes
  mimeType  String?
  createdAt DateTime @default(now())

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime?
  status      TaskStatus @default(TODO)
  assignedTo  String? // User ID
  clientId    String? // Optional client relation
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  assignee     User?   @relation("TaskAssignee", fields: [assignedTo], references: [id])
  client       Client? @relation(fields: [clientId], references: [id])
  sharedGroups Group[] @relation("GroupSharedTasks")

  @@index([assignedTo])
  @@index([status])
  @@index([dueDate])
  @@index([assignedTo, status])
  @@map("tasks")
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  action     String // e.g., "CREATE_CLIENT", "UPDATE_CLIENT", "DELETE_CONTACT"
  entityType String // e.g., "Client", "Contact", "Task"
  entityId   String?
  details    Json? // Additional details as JSON
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Theme and appearance
  theme    String? @default("light") // "light" | "dark"
  language String? @default("pl") // "pl" | "en"
  timezone String? // IANA timezone (e.g., "Europe/Warsaw", "America/New_York")

  // Color scheme
  primaryColor String? // Hex color (e.g., #3b82f6)
  themeName    String? // "blue" | "green" | "purple" | "red" | "custom" | "system"

  // Notifications
  emailTasks    Boolean @default(true)
  emailContacts Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String // JSON string or plain string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  plan      PlanType @default(BASIC)
  settings  Json?    // Konfiguracja funkcji per-organizacja
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users       User[]
  clients     Client[]
  featureFlags FeatureFlag[]

  @@map("organizations")
}

model FeatureFlag {
  id             String   @id @default(cuid())
  organizationId String?
  featureKey     String   // np. "multi_tenant", "advanced_reports", "external_integrations"
  enabled        Boolean  @default(false)
  config         Json?    // Dodatkowa konfiguracja
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, featureKey])
  @@index([organizationId])
  @@index([featureKey])
  @@map("feature_flags")
}

model IntegrationTab {
  id        String   @id @default(cuid())
  clientId  String
  title     String
  content   Json     // Dynamiczna zawartość zakładki
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([order])
  @@map("integration_tabs")
}
